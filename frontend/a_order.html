<!-- frontend/a_order.html -->
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Админка — Редактирование заказа</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <style>
        /* Красная рамка для изменённых полей */
        .changed-field {
            border: 2px solid #dc3545 !important;
        }
    </style>
</head>

<body>
    <!-- Навигация (копия из order.html, но ссылки заменены на админские) -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"
                    class="me-2">
                    <path
                        d="M12 .75a8.25 8.25 0 0 0-4.135 15.39c.686.398 1.115 1.008 1.134 1.623a.75.75 0 0 0 .577.706c.352.083.71.148 1.074.195.323.041.6-.218.6-.544v-4.661a6.714 6.714 0 0 1-.937-.171.75.75 0 1 1 .374-1.453 5.261 5.261 0 0 0 2.626 0 .75.75 0 1 1 .374 1.452 6.712 6.712 0 0 1-.937.172v4.66c0 .327.277.586.6.545.364-.047.722-.112 1.074-.195a.75.75 0 0 0 .577-.706c.02-.615.448-1.225 1.134-1.623A8.25 8.25 0 0 0 12 .75Z" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M9.013 19.9a.75.75 0 0 1 .877-.597 11.319 11.319 0 0 0 4.22 0 .75.75 0 1 1 .28 1.473 12.819 12.819 0 0 1-4.78 0 .75.75 0 0 1-.597-.876ZM9.754 22.344a.75.75 0 0 1 .824-.668 13.682 13.682 0 0 0 2.844 0 .75.75 0 1 1 .156 1.492 15.156 15.156 0 0 1-3.156 0 .75.75 0 0 1-.668-.824Z" />
                </svg>
                <strong>Ламповый завод — Админка</strong>
            </span>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="contacts.html">Контакты</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="a_index.html" class="btn btn-outline-dark me-2">Главная</a>
                    <a href="login.html" class="btn btn-outline-primary">Выход</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основное содержимое: форма редактирования заказа -->
    <div class="container my-5">
        <h1 class="page-title text-center mb-4">Редактирование заказа</h1>
        <div class="row">
            <!-- Левая колонка: продукты -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Товары в заказе (всех продуктов из каталога):</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table mb-0" id="products-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Название</th>
                                    <th class="text-end">Цена (₽)</th>
                                    <th class="text-center">Кол-во</th>
                                    <th class="text-end">Сумма (₽)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Строки с товарами вставятся сюда через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Поле комментария -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Комментарий</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="adminComment" rows="3"></textarea>
                    </div>
                </div>

                <!-- Поле шаблона -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Шаблон</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" id="orderTemplate" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <!-- Правая колонка: данные для доставки и итог -->
            <div class="col-md-4">
                <!-- Форма данных клиента -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Данные для доставки</h5>
                    </div>
                    <div class="card-body">
                        <form id="orderForm">
                            <div class="mb-3">
                                <label for="orderName" class="form-label">Номер заказа:</label>
                                <input type="text" id="orderName" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="orderDate" class="form-label">Дата заказа:</label>
                                <input type="text" id="orderDate" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="name" class="form-label">Имя:</label>
                                <input type="text" id="name" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">E-mail:</label>
                                <input type="email" id="email" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Телефон:</label>
                                <input type="tel" id="phone" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Адрес доставки:</label>
                                <textarea id="address" class="form-control" rows="3" readonly></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="status" class="form-label">Статус:</label>
                                <select id="status" class="form-select">
                                    <option value="новый">Новый</option>
                                    <option value="в обработке">В обработке</option>
                                    <option value="отгружен">Отгружен</option>
                                    <option value="отменен">Отменен</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Сайдбар с итогом -->
                <div class="card p-3">
                    <h5 class="card-title">Итоги заказа</h5>
                    <p>Позиций: <span id="summary-count">0</span></p>
                    <p>Общее кол-во: <span id="summary-qty">0</span> шт.</p>
                    <p class="h4">Сумма: <span id="summary-sum" class="text-primary">0 ₽</span></p>
                    <div class="d-grid">
                        <button id="saveOrder" class="btn btn-primary btn-lg">Изменить заказ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer bg-light text-center py-3 fixed-bottom">
        2025 © Ламповый завод — фабрика по производству ламп различного назначения.
    </footer>

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const productsTableBody = document.querySelector('#products-table tbody');
            const summaryCount = document.getElementById('summary-count');
            const summaryQty = document.getElementById('summary-qty');
            const summarySum = document.getElementById('summary-sum');
            const saveButton = document.getElementById('saveOrder');

            // Поля формы доставки
            const orderNameField = document.getElementById('orderName');
            const orderDateField = document.getElementById('orderDate');
            const nameField = document.getElementById('name');
            const emailField = document.getElementById('email');
            const phoneField = document.getElementById('phone');
            const addressField = document.getElementById('address');
            const statusField = document.getElementById('status');
            const commentField = document.getElementById('adminComment');
            const templateField = document.getElementById('orderTemplate');

            // Извлекаем orderName из URL: /edit_<orderName>.html
            const path = window.location.pathname;
            const orderName = path.replace('/edit_', '').replace('.html', '');

            let products = [];
            let orderData = null;

            // Загрузка всех товаров из базы
            async function loadProducts() {
                try {
                    const resp = await axios.get('/api/v1/products/');
                    products = resp.data;
                } catch (err) {
                    alert('Не удалось загрузить список товаров');
                }
            }

            // Загрузка данных заказа из базы
            async function loadOrderData() {
                try {
                    const resp = await axios.get(`/api/v1/orders/${orderName}`);
                    orderData = resp.data;
                    // Заполняем поля доставки
                    orderNameField.value = orderData.order_name || '';
                    const rawDate = orderData.order_date || '';
                    const dateObj = new Date(rawDate);
                    orderDateField.value = (!rawDate || isNaN(dateObj)) ? '' : dateObj.toISOString().slice(0, 10);

                    nameField.value = orderData.customer_name || '';
                    emailField.value = orderData.customer_email || '';
                    phoneField.value = orderData.customer_phone || '';
                    addressField.value = orderData.delivery_address || '';
                    statusField.value = orderData.status || 'новый';
                    commentField.value = orderData.comment || '';
                    templateField.value = orderData.template || '';
                } catch (err) {
                    alert('Не удалось загрузить данные заказа');
                }
            }

            // Рендеринг таблицы товаров с предзаполнением из orderData.items
            function renderProductsTable() {
                productsTableBody.innerHTML = '';
                const itemsMap = {};
                if (orderData && Array.isArray(orderData.items)) {
                    orderData.items.forEach(i => {
                        itemsMap[i.product_id] = i;
                    });
                }
                products.forEach(p => {
                    const tr = document.createElement('tr');

                    // Название
                    const tdName = document.createElement('td');
                    tdName.textContent = p.name;
                    tr.appendChild(tdName);

                    // Цена (editable)
                    const tdPrice = document.createElement('td');
                    tdPrice.classList.add('text-end');
                    const priceInput = document.createElement('input');
                    priceInput.type = 'number';
                    priceInput.min = '0';
                    priceInput.step = '0.01';
                    priceInput.classList.add('form-control', 'price-input');
                    priceInput.style.width = '100px';
                    const itemData = itemsMap[p.id];
                    priceInput.value = itemData ? itemData.price : p.price;
                    priceInput.dataset.id = p.id;
                    tdPrice.appendChild(priceInput);
                    tr.appendChild(tdPrice);

                    // Кол-во (editable)
                    const tdQty = document.createElement('td');
                    tdQty.classList.add('text-center');
                    const qtyInput = document.createElement('input');
                    qtyInput.type = 'number';
                    qtyInput.min = '0';
                    qtyInput.classList.add('form-control', 'qty-input');
                    qtyInput.style.width = '60px';
                    qtyInput.value = itemData ? itemData.quantity : 0;
                    qtyInput.dataset.id = p.id;
                    tdQty.appendChild(qtyInput);
                    tr.appendChild(tdQty);

                    // Сумма (price * qty)
                    const tdLineSum = document.createElement('td');
                    tdLineSum.classList.add('text-end');
                    const sumSpan = document.createElement('span');
                    sumSpan.classList.add('line-sum');
                    const currentPrice = parseFloat(priceInput.value) || 0;
                    const currentQty = parseInt(qtyInput.value) || 0;
                    sumSpan.textContent = (currentPrice * currentQty).toFixed(2);
                    tdLineSum.appendChild(sumSpan);
                    tr.appendChild(tdLineSum);

                    productsTableBody.appendChild(tr);
                });
            }

            // Пересчет итогов и пометка изменённых полей
            function recalcAndMarkChanges() {
                const rows = productsTableBody.querySelectorAll('tr');
                let count = 0, qtyTotal = 0, sumTotal = 0;
                rows.forEach(tr => {
                    const priceInput = tr.querySelector('.price-input');
                    const qtyInput = tr.querySelector('.qty-input');
                    const sumSpan = tr.querySelector('.line-sum');
                    const prodId = parseInt(priceInput.dataset.id);
                    const origItem = orderData.items ? orderData.items.find(i => i.product_id === prodId) : null;

                    const price = parseFloat(priceInput.value) || 0;
                    const qty = parseInt(qtyInput.value) || 0;
                    const lineSum = price * qty;
                    sumSpan.textContent = lineSum.toFixed(2);

                    if (qty > 0) {
                        count += 1;
                        qtyTotal += qty;
                        sumTotal += lineSum;
                    }

                    // Отметка изменённых полей
                    if (origItem) {
                        if (price !== origItem.price) priceInput.classList.add('changed-field');
                        else priceInput.classList.remove('changed-field');

                        if (qty !== origItem.quantity) qtyInput.classList.add('changed-field');
                        else qtyInput.classList.remove('changed-field');
                    } else {
                        // Если товара не было в первоначальном заказе, а он выбран (qty > 0) или цена отличается от каталога
                        if (qty > 0 || price !== parseFloat(priceInput.defaultValue)) {
                            priceInput.classList.add('changed-field');
                            qtyInput.classList.add('changed-field');
                        } else {
                            priceInput.classList.remove('changed-field');
                            qtyInput.classList.remove('changed-field');
                        }
                    }
                });
                summaryCount.textContent = count;
                summaryQty.textContent = qtyTotal;
                summarySum.textContent = sumTotal.toFixed(2) + ' ₽';

                // Статус и комментарий
                if (statusField.value !== (orderData.status || 'новый')) {
                    statusField.classList.add('changed-field');
                } else {
                    statusField.classList.remove('changed-field');
                }
                if (commentField.value !== (orderData.comment || '')) {
                    commentField.classList.add('changed-field');
                } else {
                    commentField.classList.remove('changed-field');
                }
                if (templateField.value !== (orderData.template || '')) {
                    templateField.classList.add('changed-field');
                } else {
                    templateField.classList.remove('changed-field');
                }
            }

            // Слушатели на изменение цен и кол-ва
            productsTableBody.addEventListener('input', () => {
                recalcAndMarkChanges();
            });
            statusField.addEventListener('change', recalcAndMarkChanges);
            commentField.addEventListener('input', recalcAndMarkChanges);
            templateField.addEventListener('input', recalcAndMarkChanges);

            // Сохранение заказа
            saveButton.addEventListener('click', async () => {
                // Собираем обновлённые данные
                const items = [];
                const rows = productsTableBody.querySelectorAll('tr');
                rows.forEach(tr => {
                    const priceInput = tr.querySelector('.price-input');
                    const qtyInput = tr.querySelector('.qty-input');
                    const prodId = parseInt(priceInput.dataset.id);
                    const price = parseFloat(priceInput.value) || 0;
                    const quantity = parseInt(qtyInput.value) || 0;
                    if (quantity > 0) {
                        items.push({ product_id: prodId, price, quantity });
                    }
                });

                const payload = {
                    items,
                    status: statusField.value,
                    comment: commentField.value,
                    template: templateField.value
                };

                try {
                    await axios.put(`/api/v1/orders/${orderName}`, payload);
                    alert('Заказ успешно обновлён');
                    // После успеха сбрасываем классы изменений
                    recalcAndMarkChanges();
                } catch (err) {
                    console.error('Ошибка при обновлении заказа:', err);
                    alert('Не удалось обновить заказ');
                }
            });

            // Последовательность загрузки
            await loadProducts();
            await loadOrderData();
            renderProductsTable();
            recalcAndMarkChanges();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>