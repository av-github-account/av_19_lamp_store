<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Оформление заказа — Ламповый магазин</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <!-- Логотип: полный SVG и текст -->
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"
                    class="me-2">
                    <path
                        d="M12 .75a8.25 8.25 0 0 0-4.135 15.39c.686.398 1.115 1.008 1.134 1.623a.75.75 0 0 0 .577.706c.352.083.71.148 1.074.195.323.041.6-.218.6-.544v-4.661a6.714 6.714 0 0 1-.937-.171.75.75 0 1 1 .374-1.453 5.261 5.261 0 0 0 2.626 0 .75.75 0 1 1 .374 1.452 6.712 6.712 0 0 1-.937.172v4.66c0 .327.277.586.6.545.364-.047.722-.112 1.074-.195a.75.75 0 0 0 .577-.706c.02-.615.448-1.225 1.134-1.623A8.25 8.25 0 0 0 12 .75Z" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M9.013 19.9a.75.75 0 0 1 .877-.597 11.319 11.319 0 0 0 4.22 0 .75.75 0 1 1 .28 1.473 12.819 12.819 0 0 1-4.78 0 .75.75 0 0 1-.597-.876ZM9.754 22.344a.75.75 0 0 1 .824-.668 13.682 13.682 0 0 0 2.844 0 .75.75 0 1 1 .156 1.492 15.156 15.156 0 0 1-3.156 0 .75.75 0 0 1-.668-.824Z" />
                </svg>
                <strong>Ламповый завод</strong>
            </a>

            <!-- Бургер для мобильных -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Навигационные ссылки и кнопки -->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="contacts.html">Контакты</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="order.html" class="btn btn-outline-dark me-2">Оформить заказ</a>
                    <a href="login.html" class="btn btn-outline-primary">Вход</a>
                </div>
            </div>
        </div>
    </nav>


    <div class="container my-5">
        <h1 class="page-title">Оформление заказа</h1>
        <div class="row">
            <div class="col-md-8">
                <!-- Таблица со всеми товарами -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Выберите количество для каждого товара:</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table mb-0" id="products-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Название</th>
                                    <th class="text-end">Цена</th>
                                    <th class="text-center">Кол-во</th>
                                    <th class="text-end">Сумма</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- сюда вставятся строки -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Форма данных клиента -->
                <div class="card">
                    <div class="card-header">
                        <h5>Данные для доставки:</h5>
                    </div>
                    <div class="card-body">
                        <form id="order-form" novalidate>
                            <div class="mb-3">
                                <label for="name" class="form-label">Имя:</label>
                                <input type="text" id="name" class="form-control" required value="Иванов">
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">E-mail:</label>
                                <input type="email" id="email" class="form-control" required value="test@mail.ru">
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Телефон:</label>
                                <input type="tel" id="phone" class="form-control" required value="+79000000000">
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Адрес доставки:</label>
                                <textarea id="address" class="form-control" rows="3" required
                                    value="Предзаполненный адрес доставки, для экономии времени при разработке сервиса."></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Сайдбар с итогом -->
            <div class="col-md-4">
                <div class="card p-3">
                    <h5 class="card-title">Итого</h5>
                    <p>Позиций в заказе: <span id="summary-count">0</span></p>
                    <p>Общее кол-во: <span id="summary-qty">0</span> шт.</p>
                    <p class="h4">
                        Сумма: <span id="summary-sum" class="text-primary">0 руб.</span>
                    </p>
                    <button id="submit-order" class="btn btn-primary btn-lg w-100">
                        Оформить заказ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer bg-light text-center py-3 fixed-bottom">
        2025 © Ламповый завод — фабрика по производству ламп различного назначения.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const tableBody = document.querySelector('#products-table tbody');
            const summaryCount = document.getElementById('summary-count');
            const summaryQty = document.getElementById('summary-qty');
            const summarySum = document.getElementById('summary-sum');

            // 0. Читаем текущую корзину из sessionStorage
            const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');

            // 1. Загружаем все товары
            let products = [];
            try {
                const resp = await axios.get('/api/v1/products/');
                products = resp.data;
            } catch (e) {
                return alert('Не удалось загрузить список товаров');
            }

            // 2. Рендерим строки таблицы, подставляя сохранённые в cart количества
            products.forEach((p, idx) => {
                const tr = document.createElement('tr');
                const saved = cart.find(i => i.product_id === p.id);
                const qtyValue = saved ? saved.quantity : 0;

                tr.innerHTML = `
      <td>${p.name}</td>
      <td class="text-end">${p.price} руб.</td>
      <td class="text-center">
        <input
          type="number"
          min="0"
          value="${qtyValue}"
          class="form-control qty"
          data-id="${p.id}"
          style="width:80px; margin:auto;"
        >
      </td>
      <td class="text-end"><span class="line-sum">0</span> руб.</td>
    `;
                tableBody.appendChild(tr);
            });

            // 3. Функция пересчёта итогов и сохранения cart
            function recalc() {
                const rows = tableBody.querySelectorAll('tr');
                let count = 0, qty = 0, sum = 0;
                const newCart = [];

                rows.forEach((tr, idx) => {
                    const input = tr.querySelector('.qty');
                    let q = Math.max(0, parseInt(input.value) || 0);
                    const price = products[idx].price;
                    const lineSum = price * q;
                    tr.querySelector('.line-sum').textContent = lineSum;

                    if (q > 0) {
                        count += 1;
                        qty += q;
                        sum += lineSum;
                        newCart.push({ product_id: products[idx].id, quantity: q });
                    }
                });

                // Сохраняем обновлённую корзину
                sessionStorage.setItem('cart', JSON.stringify(newCart));

                summaryCount.textContent = count;
                summaryQty.textContent = qty;
                summarySum.textContent = sum + ' руб.';
            }

            // 4. Слушатель на изменение любого input.qty
            tableBody.addEventListener('input', e => {
                if (e.target.classList.contains('qty')) {
                    // можно, при желании, сразу ограничить max из products
                    const id = +e.target.dataset.id;
                    const prod = products.find(x => x.id === id);
                    if (prod && e.target.value > prod.stock_quantity) {
                        e.target.value = prod.stock_quantity;
                    }
                    recalc();
                }
            });

            // 5. Запускаем recalc один раз после отрисовки, чтобы применить сохранённые данные
            recalc();

            // 6. Отправка заказа
            document.getElementById('submit-order').addEventListener('click', async () => {
                const form = document.getElementById('order-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                const items = JSON.parse(sessionStorage.getItem('cart') || '[]');
                if (items.length === 0) {
                    return alert('Укажите количество хотя бы для одного товара');
                }
                const data = {
                    customer_name: form.querySelector('#name').value,
                    customer_email: form.querySelector('#email').value,
                    customer_phone: form.querySelector('#phone').value,
                    delivery_address: form.querySelector('#address').value,
                    comment: form.querySelector('#comment')?.value || '',
                    items
                };
                try {
                    const res = await axios.post('/api/v1/orders/', data);
                    sessionStorage.removeItem('cart');
                    window.location.href = `confirm.html?order_id=${res.data.id}`;
                } catch (err) {
                    console.error('Ошибка создания заказа', err);
                    alert('Не удалось создать заказ');
                }
            });
        });
    </script>

</body>

</html>